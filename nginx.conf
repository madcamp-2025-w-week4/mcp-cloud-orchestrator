# =============================================================================
# MCP Cloud Orchestrator - Nginx Reverse Proxy Configuration
# =============================================================================
# 설명: 단일 엔드포인트(Tailscale Funnel)를 통한 Frontend/Backend 프록시
# 설치: sudo cp nginx.conf /etc/nginx/sites-available/mcp-orchestrator
#       sudo ln -s /etc/nginx/sites-available/mcp-orchestrator /etc/nginx/sites-enabled/
#       sudo nginx -t && sudo systemctl reload nginx
# =============================================================================

upstream frontend {
    server 127.0.0.1:5174;
    keepalive 64;
}

upstream backend {
    server 127.0.0.1:8000;
    keepalive 64;
}

server {
    listen 80;
    listen [::]:80;
    server_name camp-gpu-16.tailab95b0.ts.net localhost;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Gzip Compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;

    # ==========================================================================
    # API Routes → FastAPI Backend (localhost:8000)
    # /api/nodes → /nodes, /api/instances → /instances
    # ==========================================================================
    location /api/ {
        # Strip /api prefix before forwarding to backend
        rewrite ^/api/(.*)$ /$1 break;
        
        proxy_pass http://backend;
        proxy_http_version 1.1;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Disable buffering for streaming responses
        proxy_buffering off;
    }

    # ==========================================================================
    # WebSocket Terminal → FastAPI Backend (localhost:8000)
    # /ws/* → WebSocket 터미널 연결
    # ==========================================================================
    location /ws/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        
        # WebSocket upgrade headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Long timeouts for terminal sessions
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        
        proxy_buffering off;
    }

    # ==========================================================================
    # Ray Dashboard → Ray Head Node (localhost:8265)
    # /ray/* → http://127.0.0.1:8265/*
    # ==========================================================================
    location /ray/ {
        # Strip /ray prefix
        rewrite ^/ray/(.*)$ /$1 break;
        
        proxy_pass http://127.0.0.1:8265;
        proxy_http_version 1.1;
        
        # WebSocket support for Ray Dashboard
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts for long-running requests
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        proxy_buffering off;
    }

    # Ray Dashboard static assets
    location /ray {
        return 301 /ray/;
    }

    # ==========================================================================
    # WebSocket for Vite HMR (Hot Module Replacement) - Development Only
    # ==========================================================================
    location /@vite/ {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location /__vite_ping {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    # ==========================================================================
    # Frontend Routes → React Dev Server (localhost:5174)
    # ==========================================================================
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        
        # WebSocket support for HMR
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache static assets
        proxy_cache_bypass $http_upgrade;
    }

    # ==========================================================================
    # Health Check Endpoint
    # ==========================================================================
    location /nginx-health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
